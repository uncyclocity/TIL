# 19. 브라우저 렌더링 과정

> References <br> <a href="http://www.yes24.com/Product/Goods/92742567?OzSrank=1">모던 자바스크립트 Deep Dive</a> _.이웅모_

## 1. 브라우저 렌더링 과정

- 브라우저는 서버와의 데이터 통신을 통해 **렌더링**을 수행한다.
  1. 서버로부터 자원 요청 후 응답받기
  2. HTML 파싱 후 DOM 생성
  3. CSS 파싱 후 CSSOM 생성
  4. 렌더 트리 생성
  5. JS 파싱 후 AST 생성
  6. 렌더 트리로 HTML을 브라우저에 페인팅

## 2. 서버로부터 자원 요청 후 응답받기

- 브라우저는 HTML, CSS, JS 등을 요청하여 응답을 받아 렌더링을 해야 한다.
- URL이 입력되면, **호스트 이름**이 DNS를 통해 **IP 주소로 변환**되고, 이 IP 주소를 갖는 서버에게 요청이 전달된다.

## 3. HTML 파싱 후 DOM 생성

- **렌더링 엔진**(웹킷, 게코 등)이 문자열을 파싱하여 브라우저가 이해할 수 있는 자료구조 DOM을 생성한다.

- HTML DOM 생성과정
  1. 서버로부터 받은 HTML은 **바이트**로 이루어져 있으며, **문자열**로 바꾸게 된다.
  2. 문자열로 변형 된 HTML 문서는 각각 **토큰**으로 분해된다.
  3. 토큰은 각각 **객체로 변환되어 노드를 생성**한다. 문서/요소/어트리뷰트/텍스트 노드로 생성되며 DOM을 구성하는 기본 요소가 된다.
  4. 각 노드들은 부모-자식 관계로 구성되어 트리 자료구조로 구성되어진다. 이를 **DOM**이라고 한다.

## 4. CSS 파싱 후 CSSOM 생성

- DOM을 구성하는 도중에 CSS를 로딩하는 태그인 **style**이나 **link**를 만나면 **DOM 생성을 일시 중단**한다.
- CSS 파일을 서버에 요청하여 응답받은 후, **HTML과 동일한 과정(바이트 ➡ 문자열 ➡ 토큰 ➡ 노드)을 거쳐 CSSOM을 생성**한다.
- CSS 파싱이 마무리되면, **HTML 파싱이 일시 중지 된 시점부터 다시 DOM을 생성**한다.

## 5. 렌더 트리 생성

- **렌더 트리**란? 렌더링에 필요한 트리 구조의 자료구조이다.
- **DOM**과 **CSSOM**을 합쳐서 만든다.
- **화면에 렌더링 되는 노드만**으로 구성된다. 즉, 뷰단에 렌더링 되지 않는 노드(meta 등)나 CSS에 의해 표시가 되지 않는 노드(display: none 등)을 제외하고 만든다.

## 6. JS 파싱 후 AST 생성

- DOM을 구성하는 도중에 JS를 로딩하는 태그인 **script**를 만나면 DOM 생성을 일시 중단하고 **렌더링 엔진에서 JS엔진에게 제어권이 넘어간다.**
- JS 엔진은 코드 파싱 후 **AST**(추상적 구문 트리)를 생성하며, AST를 기반으로 인터프리터가 실행할 수 있는 바이트코드를 생성하여 실행한다.
- JS 파싱 및 실행 과정 종료 시, 렌더링 엔진으로 제어권이 다시 넘어가서 일시 중지 된 시점부터 DOM 생성을 재개한다.

- AST 생성 과정
  1. JS 코드를 각각 문법적 의미를 갖는 토큰들로 분해한다.
  2. 토큰들의 집합을 통해 **AST를 생성**한다.
  3. AST는 **바이트코드로 변환**되어 인터프리터에 의해 실행된다.

## 7. 렌더 트리로 HTML을 브라우저에 페인팅

- 렌더 트리는 HTML 요소의 **레이아웃 계산**과 뷰단에 렌더링하는 **페인팅 처리**에 사용된다.
- **JS에 의해 노드가 추가**되거나 **브라우저 창이 리사이징** 되었을 경우, 레이아웃 계산과 페인팅 처리가 다시 일어난다. <br>
  👉 이를 **리플로우**, **리페인트**라고 하며, 각각 레이아웃 계산과 페인트를 다시 하는 것을 의미한다. 만약 레이아웃에 영향이 없는 변경일 경우 리페인팅만 진행된다.

## 8. JS 파싱에 의한 HTML 블로킹

- 브라우저는 **동기적으로 (위에서 아래로) HTML/CSS/JS를 파싱**한다. <br>
  👉 **script 태그의 위치**에 따라 HTML 파싱이 블로킹 되어 DOM 생성이 지연될 수 있다.
- 만약 JS 코드가 노드를 추가할 경우, **DOM이 이미 생성되어있어야 한다.**
- script 코드는 **JS 코드의 맨 아래**에 위치시키는게 좋다.

## 9. script 태그의 async/defer 어트리뷰트

- **DOM 로딩**과 **스크립트 로딩**을 **동시에 진행**시키도록 하는 어트리뷰트이다.
- **외부 JS를 로딩하는 경우**에만 사용하며, 인라인으로 작성된 스크립트는 사용할 수 없다.
- async
  - JS의 파싱 및 실행이 **JS 파일이 로드 된 직후 실행**되며, 이때 **DOM 생성이 일시 중지**된다.
  - 여러 script 태그에 async 적용 시, **먼저 로드된 script 태그부터 실행**되기에 순서가 보장되지 않는다.
- defer
  - JS의 파싱 및 실행이 **DOM이 생성 된 이후 실행**된다.
  - DOM 생성 이후 실행해야 할 JS에 유용하다.
